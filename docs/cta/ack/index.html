<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Acknowledging… — Arthur Rai Medical Services</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow">
  <meta name="referrer" content="no-referrer">
  <style>
    :root { color-scheme: light dark; }
    html,body{height:100%}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f7f7fb;margin:0;line-height:1.45}
    .container{max-width:900px;margin:0 auto;padding:16px}
    header.brand{padding:12px 0 0}
    .brand img{height:320px;width:auto;display:block;max-width:100%}
    .stage{display:flex;justify-content:center}
    .card{max-width:720px;width:100%;background:#fff;border-radius:16px;box-shadow:0 4px 16px rgba(0,0,0,.10);padding:22px;margin:12px 8px 24px}
    h1{margin:0 0 10px;font-size:22px}
    p{margin:8px 0;color:#444}
    .muted{color:#666}
    .note{font-size:12px;margin-top:12px;color:#666}
    .btns{margin-top:16px;display:flex;gap:10px;flex-wrap:wrap}
    button.btn{appearance:none;border:1px solid #1a73e8;background:#1a73e8;color:#fff;padding:10px 14px;border-radius:10px;font-weight:600}
    button.btn.secondary{background:#fff;color:#1a73e8}
    button.btn[disabled]{opacity:0.6;cursor:not-allowed}
    .spinner{display:inline-block;width:18px;height:18px;border-radius:50%;border:3px solid #cfe0ff;border-top-color:#1a73e8;vertical-align:middle;animation:s 0.8s linear infinite;margin-right:8px}
    @keyframes s{to{transform:rotate(360deg)}}
    .hide{display:none}
    ul{margin:8px 0 0 18px}
    code{background:#f1f3f9;padding:0 4px;border-radius:6px}
  </style>
</head>
<body>
  <div class="container">
    <header class="brand" aria-label="Arthur Rai Medical Services">
      <a href="https://www.arthur-rai.co.uk/" aria-label="Arthur Rai Medical Services — Home">
        <img src="./assets/arthurrai.png" alt="Arthur Rai Medical Services">
      </a>
    </header>
  </div>

  <div class="stage">
    <div class="card" id="panel-progress">
      <h1><span class="spinner" aria-hidden="true"></span> Preparing your acknowledgement…</h1>
      <p class="muted">We’re updating our system automatically. This should only take a moment.</p>
      <div class="btns">
        <button class="btn secondary" id="cancelBtn" type="button">Cancel</button>
      </div>
      <p class="note">Do not share this link. It may expire.</p>
    </div>

    <div class="card hide" id="panel-result">
      <h1 id="resultTitle">Acknowledgement confirmed.</h1>
      <div id="resultBody"></div>
      <div class="btns" id="bulkBtns" style="display:none">
        <button class="btn" id="acceptAllBtn" type="button">Accept all outstanding</button>
        <button class="btn secondary" id="closeBtn" type="button">Close</button>
      </div>
      <div class="btns" id="soloCloseBtns" style="display:none">
        <button class="btn secondary" id="closeBtnSolo" type="button">Close</button>
      </div>
    </div>

    <div class="card hide" id="panel-error">
      <h1>We can’t process this link</h1>
      <p class="muted" id="errText">The link is missing required data.</p>
      <div class="btns">
        <button class="btn" id="retryBtn" type="button">Retry</button>
        <button class="btn secondary" id="errCloseBtn" type="button">Close</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    // ====== CONFIG ======
    var GAS_BASE = "https://script.google.com/macros/s/AKfycbw9X71BbvC55s2iJhyfGU5PoBtOxC9jvFsdKpd8BvrNghMfw8Yy9X-iSZ1Xcw9oTAPMcA/exec";

    // ====== utils ======
    function qs(name){
      var m = new RegExp("[?&]"+name+"=([^&#]*)").exec(window.location.search);
      return m ? decodeURIComponent(m[1].replace(/\+/g,"%20")) : "";
    }
    function show(id){document.getElementById(id).classList.remove("hide");}
    function hide(id){document.getElementById(id).classList.add("hide");}
    function el(id){return document.getElementById(id);}

    // JSONP loader
    function jsonp(url, cbName, onDone, onErr){
      var done=false, s=document.createElement('script');
      var timer=setTimeout(function(){ if(done) return; done=true; onErr&&onErr(new Error('Timeout')); cleanup(); }, 12000);
      function cleanup(){ try{ s.remove(); }catch(_){} window[cbName]=function(){}; clearTimeout(timer); }
      window[cbName] = function(data){ if(done) return; done=true; try{ onDone && onDone(data); } finally { cleanup(); } };
      s.src = url + (url.indexOf('?')>-1?'&':'?') + 'callback=' + encodeURIComponent(cbName) + '&_=' + Date.now();
      s.onerror = function(){ if(done) return; done=true; onErr&&onErr(new Error('Network error')); cleanup(); };
      document.head.appendChild(s);
    }

    // ====== flow ======
    function run(){
      hide("panel-error"); hide("panel-result"); show("panel-progress");

      // reset button groups to avoid stale state on retries
      el('bulkBtns').style.display = 'none';
      el('soloCloseBtns').style.display = 'none';

      var composite = qs("p"); // "alertId" or "alertId~msisdn"
      if (!composite) {
        hide("panel-progress"); show("panel-error");
        el("errText").textContent = "Missing parameter. Please tap the WhatsApp button again.";
        return;
      }

      // Step 1: get short-lived token
      var cb1 = 'cb_ack_link_' + Math.random().toString(36).slice(2);
      jsonp(GAS_BASE + '?action=EMERGENCY_ACK_LINK_EMBED&p=' + encodeURIComponent(composite), cb1, function(res1){
        if (!res1 || !res1.payload || !res1.payload.ok) { throw new Error('Token error'); }
        var t = res1.payload.t, alertId = res1.payload.alert_id, msisdn = res1.payload.msisdn || '';

        // Step 2: commit single
        var cb2 = 'cb_ack_commit_' + Math.random().toString(36).slice(2);
        var url2 = GAS_BASE + '?action=EMERGENCY_ACK_COMMIT_EMBED&alert_id=' + encodeURIComponent(alertId) +
                   '&t=' + encodeURIComponent(t) + (msisdn?('&msisdn='+encodeURIComponent(msisdn)):'');
        jsonp(url2, cb2, function(res2){
          hide('panel-progress'); show('panel-result');

          var payload = (res2 && res2.payload) || {};
          var kind = payload.kind || (payload.ok ? 'done' : 'error');
          var others = payload.others || [];
          var bulk = payload.bulk || null;

          el('resultTitle').textContent = (kind === 'already') ? 'Already acknowledged.' :
                                          (kind === 'done'    ? 'Acknowledgement confirmed.' : 'Something went wrong.');
          var b = el('resultBody');
          b.innerHTML = '';

          if (kind === 'done') {
            b.innerHTML = '<p>We’ve recorded your acknowledgement and stopped further escalations.</p>';
          } else if (kind === 'already') {
            b.innerHTML = '<p class="muted">This alert was already acknowledged.</p>';
          } else {
            b.innerHTML = '<p class="muted">Please try again.</p>';
          }

          // Offer Accept All
          if (others && others.length && bulk && bulk.idsCsv && bulk.t) {
            el('bulkBtns').style.display = '';
            el('soloCloseBtns').style.display = 'none';  // ensure solo close is hidden when bulk shown
            var list = document.createElement('ul');
            others.slice(0,6).forEach(function(o){
              var li = document.createElement('li');
              li.textContent = [o.candidate_name || 'Colleague', o.role || '', o.hospital || '', o.ward || '', o.date_label || '', o.time_range_label || '', o.shift_type || '', o.issue_type || ''].filter(Boolean).join(' · ');
              list.appendChild(li);
            });
            if (others.length > 6) {
              var more = document.createElement('p');
              more.className = 'muted';
              more.textContent = '+' + (others.length - 6) + ' more';
              b.appendChild(more);
            }
            b.appendChild(list);

            el('closeBtn').onclick = function(){ try{ window.close(); }catch(_){} };
            el('acceptAllBtn').onclick = function(){
              el('acceptAllBtn').disabled = true;
              var cb3 = 'cb_ack_all_' + Math.random().toString(36).slice(2);
              var url3 = GAS_BASE + '?action=EMERGENCY_ACK_ALL_EMBED&ids=' + encodeURIComponent(bulk.idsCsv) +
                         '&msisdn=' + encodeURIComponent(bulk.msisdn||'') + '&t=' + encodeURIComponent(bulk.t);
              jsonp(url3, cb3, function(res3){
                var p3 = (res3 && res3.payload) || {};
                b.innerHTML = '<p>Accepted <strong>' + (p3.ackedCount||0) + '</strong> additional alert(s).</p>';
                el('acceptAllBtn').style.display = 'none';
              }, function(){
                el('acceptAllBtn').disabled = false;
                alert('Sorry, bulk accept failed. Please try again.');
              });
            };
          } else {
            el('bulkBtns').style.display = 'none';
            el('soloCloseBtns').style.display = '';
            var sc = el('closeBtnSolo');
            if (sc) sc.onclick = function(){ try{ window.close(); }catch(_){} };
          }
        }, function(){
          hide('panel-progress'); show('panel-error');
          el('errText').textContent = 'We could not commit your acknowledgement. Please try again.';
        });
      }, function(){
        hide('panel-progress'); show('panel-error');
        el('errText').textContent = 'We could not prepare your acknowledgement. Please try again.';
      });
    }

    // wire buttons (no legacy flow)
    el("cancelBtn").onclick = function(){ try{ window.close(); }catch(_){} };
    el("errCloseBtn").onclick = function(){ try{ window.close(); }catch(_){} };
    var rb = el("retryBtn"); if (rb) rb.onclick = run;

    // kick off
    run();
  })();
  </script>
</body>
</html>
